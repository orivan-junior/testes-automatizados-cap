pipeline {
    agent any

    environment {
        CI = 'true'
        NEXUS_URL = 'http://nexus:8081'
        NEXUS_USER = 'jenkins'
        NEXUS_PASS = 'jenkins123'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Install Node.js (if not present)') {
            steps {
                sh '''
                    if ! command -v node &> /dev/null
                    then
                        echo "Instalando Node.js 18..."
                        curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
                        apt-get update
                        apt-get install -y nodejs
                    else
                        echo "Node.js jÃ¡ estÃ¡ instalado."
                    fi
                '''
            }
        }

        stage('Install Dependencies (npm ci)') {
            steps {
                sh 'npm ci'
            }
        }

        stage('Install Playwright Browsers (if not present)') {
            steps {
                sh '''
                    if ! npx playwright --version &> /dev/null
                    then
                        echo "Instalando Playwright browsers..."
                        npx playwright install --with-deps
                    else
                        echo "Playwright browsers jÃ¡ estÃ£o instalados."
                    fi
                '''
            }
        }

        stage('Generate BDD Features') {
            steps {
                sh '''
                    echo "ðŸ”§ Gerando features BDD..."
                    npx bddgen
                    echo "âœ… Features BDD geradas com sucesso!"
                '''
            }
        }

        stage('Run Tests - ContrataÃ§Ã£o (@contratacao)') {
            steps {
                sh '''
                    echo "ðŸ§ª Executando testes de contrataÃ§Ã£o..."
                    npx playwright test --grep @contratacao --reporter=allure-playwright
                    echo "âœ… Testes de contrataÃ§Ã£o concluÃ­dos!"
                '''
            }
        }

        stage('Upload Evidence to Nexus') {
            steps {
                script {
                    def timestamp = new Date().format('yyyy-MM-dd_HH-mm-ss')
                    def buildNumber = env.BUILD_NUMBER

                    sh '''
                        echo "ðŸ“¤ Fazendo upload das evidÃªncias para o Nexus..."

                        # Criar diretÃ³rio temporÃ¡rio
                        mkdir -p /tmp/evidence-upload

                        # Copiar evidÃªncias
                        cp -r test-results/screenshots /tmp/evidence-upload/ 2>/dev/null || echo "Nenhuma screenshot encontrada"
                        cp -r test-results/videos /tmp/evidence-upload/ 2>/dev/null || echo "Nenhum vÃ­deo encontrado"
                        cp -r allure-results /tmp/evidence-upload/ 2>/dev/null || echo "Nenhum resultado Allure encontrado"

                        # Criar arquivo de informaÃ§Ãµes do build
                        cat > /tmp/evidence-upload/build-info.txt << EOF
Build Number: ${BUILD_NUMBER}
Timestamp: ${timestamp}
Branch: ${GIT_BRANCH}
Commit: ${GIT_COMMIT}
Jenkins URL: ${BUILD_URL}
Test Type: ContrataÃ§Ã£o (@contratacao)
EOF

                        # Fazer upload para Nexus
                        cd /tmp/evidence-upload
                        tar -czf contratacao-evidence-${BUILD_NUMBER}-${timestamp}.tar.gz *

                        # Upload usando curl
                        curl -u ${NEXUS_USER}:${NEXUS_PASS} \
                             --upload-file contratacao-evidence-${BUILD_NUMBER}-${timestamp}.tar.gz \
                             ${NEXUS_URL}/repository/playwright-evidence/contratacao-evidence-${BUILD_NUMBER}-${timestamp}.tar.gz

                        echo "âœ… Upload concluÃ­do!"
                        echo "ðŸ”— URL: ${NEXUS_URL}/repository/playwright-evidence/contratacao-evidence-${BUILD_NUMBER}-${timestamp}.tar.gz"
                    '''
                }
            }
        }
    }

    post {
        always {
            // Gerar relatÃ³rio Allure
            allure([
                includeProperties: false,
                jdk: '',
                properties: [],
                reportBuildPolicy: 'ALWAYS',
                results: [[path: 'allure-results']]
            ])

            // Arquivos de evidÃªncia
            archiveArtifacts artifacts: 'test-results/**/*', allowEmptyArchive: true
            archiveArtifacts artifacts: 'allure-results/**/*', allowEmptyArchive: true

            // Limpar arquivos temporÃ¡rios
            sh 'rm -rf /tmp/evidence-upload'
        }

        success {
            echo "ðŸŽ‰ Pipeline executado com sucesso!"
            echo "âœ… BDD features geradas e testes de contrataÃ§Ã£o executados!"
        }

        failure {
            echo "âŒ Pipeline falhou!"
            echo "ðŸ” Verifique os logs para mais detalhes."
        }
    }
}
